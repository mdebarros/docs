<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1424px" preserveAspectRatio="none" style="width:870px;height:1424px;" version="1.1" viewBox="0 0 870 1424" width="870px" zoomAndPan="magnify"><defs><filter height="300%" id="f6wzqtfanmqg4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="312" y="23.5352">6.3.2. Settlement Transfer Commit</text><rect fill="#90EE90" height="1379.0566" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="45" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="48" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1379.0566" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="523" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="526" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="1211.7695" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="535.498"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="673.3613"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="865.8457"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="1107.9512"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="1197.7695" style="stroke: #000000; stroke-width: 2.0;" width="846" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="851.4902" style="stroke: #000000; stroke-width: 2.0;" width="826" x="23" y="472.5664"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="820.1797" style="stroke: #000000; stroke-width: 2.0;" width="806" x="33" y="496.877"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="430" x="43" y="1004.709"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="116.2871" y2="1348.0566"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="580" x2="580" y1="116.2871" y2="1348.0566"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="113.334">Settlement DAO</text><ellipse cx="110" cy="83.7988" fill="#FEFECE" filter="url(#f6wzqtfanmqg4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="1360.5918">Settlement DAO</text><ellipse cx="110" cy="1379.5449" fill="#FEFECE" filter="url(#f6wzqtfanmqg4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="1393.5449" y2="1393.5449"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="532" y="113.334">Central Store</text><path d="M562,63.7988 C562,53.7988 580,53.7988 580,53.7988 C580,53.7988 598,53.7988 598,63.7988 L598,89.7988 C598,99.7988 580,99.7988 580,99.7988 C580,99.7988 562,99.7988 562,89.7988 L562,63.7988 " fill="#FEFECE" filter="url(#f6wzqtfanmqg4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M562,63.7988 C562,73.7988 580,73.7988 580,73.7988 C580,73.7988 598,73.7988 598,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="532" y="1360.5918">Central Store</text><path d="M562,1373.5449 C562,1363.5449 580,1363.5449 580,1363.5449 C580,1363.5449 598,1363.5449 598,1373.5449 L598,1399.5449 C598,1409.5449 580,1409.5449 580,1409.5449 C580,1409.5449 562,1409.5449 562,1399.5449 L562,1373.5449 " fill="#FEFECE" filter="url(#f6wzqtfanmqg4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M562,1373.5449 C562,1383.5449 580,1383.5449 580,1383.5449 C580,1383.5449 598,1383.5449 598,1373.5449 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="1211.7695" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="535.498"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="673.3613"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="865.8457"/><rect fill="#FFFFFF" filter="url(#f6wzqtfanmqg4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="575" y="1107.9512"/><path d="M13,133.2871 L248,133.2871 L248,140.2871 L238,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1197.7695" style="stroke: #000000; stroke-width: 2.0;" width="846" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="28" y="146.8555">Settlement Transfer Commit</text><path d="M120,155.5977 L120,180.5977 L671,180.5977 L671,165.5977 L661,155.5977 L120,155.5977 " fill="#D3D3D3" filter="url(#f6wzqtfanmqg4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M661,155.5977 L661,165.5977 L671,165.5977 L661,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="126" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="169" y="173.166">: settlementId that has just been SETTLED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="563,207.2188,573,211.2188,563,215.2188,567,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="569" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="135" y="206.4766">Retrieve the list of RESERVED, but not COMMITTED</text><polygon fill="#FFFFE0" filter="url(#f6wzqtfanmqg4)" points="395,224.2188,765,224.2188,775,327.2188,765,431.2188,395,431.2188,385,327.2188,395,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="397" y="240.7871">SELECT tp.transferId, tp.participantCurrencyId, tp.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="397" y="256.0977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="437" y="256.0977">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="648" y="256.0977">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="397" y="271.4082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="429" y="271.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="572" y="271.4082">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="397" y="286.7188">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="397" y="302.0293">AND tsc1.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="397" y="317.3398">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="462" y="317.3398">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="605" y="317.3398">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="397" y="332.6504">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="397" y="347.9609">AND tsc2.transferStateId = {COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="397" y="363.2715">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="429" y="363.2715">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="560" y="363.2715">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="397" y="378.582">ON tp.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="397" y="393.8926">AND tp.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="397" y="409.2031">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="397" y="424.5137">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="126,453.5664,116,457.5664,126,461.5664,122,457.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="579" y1="457.5664" y2="457.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="452.8242">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="452.8242">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="190" y="452.8242">settlementTransferList</text><path d="M23,472.5664 L188,472.5664 L188,479.5664 L178,489.5664 L23,489.5664 L23,472.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="851.4902" style="stroke: #000000; stroke-width: 2.0;" width="826" x="23" y="472.5664"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="486.1348">DB TRANSACTION</text><path d="M33,496.877 L107,496.877 L107,503.877 L97,513.877 L33,513.877 L33,496.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="820.1797" style="stroke: #000000; stroke-width: 2.0;" width="806" x="33" y="496.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="510.4453">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="509.5117">[t IN settlementTransferList]</text><polygon fill="#A80036" points="563,531.498,573,535.498,563,539.498,567,535.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="569" y1="535.498" y2="535.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="530.7559">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="135" y="530.7559">Select participantPosition FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f6wzqtfanmqg4)" points="375,548.498,785,548.498,795,582.498,785,617.498,375,617.498,365,582.498,375,548.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="377" y="565.0664">SELECT participantPositionId, value positionValue, reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="377" y="580.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="417" y="580.377">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="377" y="595.6875">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="377" y="610.998">FOR UPDATE</text><polygon fill="#A80036" points="126,640.0508,116,644.0508,126,648.0508,122,644.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="579" y1="644.0508" y2="644.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="639.3086">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="639.3086">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="190" y="639.3086">participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="330" y="639.3086">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="338" y="639.3086">positionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="434" y="639.3086">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="461" y="639.3086">reservedValue</text><polygon fill="#A80036" points="563,669.3613,573,673.3613,563,677.3613,567,673.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="569" y1="673.3613" y2="673.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="668.6191">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="135" y="668.6191">Select participant NET_DEBIT_CAP limit</text><polygon fill="#FFFFE0" filter="url(#f6wzqtfanmqg4)" points="405,686.3613,755,686.3613,765,720.3613,755,755.3613,405,755.3613,395,720.3613,405,686.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="407" y="702.9297">SELECT value AS netDebitCap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="407" y="718.2402">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="447" y="718.2402">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="407" y="733.5508">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="407" y="748.8613">AND participantLimitTypeId = {NET_DEBIT_CAP}</text><polygon fill="#A80036" points="126,777.9141,116,781.9141,126,785.9141,122,781.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="579" y1="781.9141" y2="781.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="777.1719">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="777.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="190" y="777.1719">netDebitCap</text><path d="M120,794.9141 L120,834.9141 L651,834.9141 L651,804.9141 L641,794.9141 L120,794.9141 " fill="#D3D3D3" filter="url(#f6wzqtfanmqg4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M641,794.9141 L641,804.9141 L651,804.9141 L641,794.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="126" y="812.4824">isLimitExceeded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="240" y="812.4824">= netDebitCap - positionValue - reservedValue - t.amount &lt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="126" y="827.793">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="220" y="827.793">= positionValue + t.amount</text><polygon fill="#A80036" points="563,861.8457,573,865.8457,563,869.8457,567,865.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="569" y1="865.8457" y2="865.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="861.1035">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="135" y="861.1035">Persist latestPosition</text><polygon fill="#FFFFE0" filter="url(#f6wzqtfanmqg4)" points="414,878.8457,745,878.8457,755,920.8457,745,962.8457,414,962.8457,404,920.8457,414,878.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="416" y="895.4141">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="470" y="895.4141">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="416" y="910.7246">SET value = {latestPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="416" y="926.0352">WHERE participantPositionId = participantPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="420" y="941.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="416" y="956.6563">SELECT LAST_INSERT_ID() AS participantPositionId</text><polygon fill="#A80036" points="126,985.709,116,989.709,126,993.709,122,989.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="579" y1="989.709" y2="989.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="984.9668">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="984.9668">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="190" y="984.9668">participantPositionId</text><path d="M43,1004.709 L110,1004.709 L110,1011.709 L100,1021.709 L43,1021.709 L43,1004.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="430" x="43" y="1004.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="1018.2773">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="125" y="1017.3438">[isLimitExceeded == true]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="157" y1="1058.6406" y2="1058.6406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="157" y1="1058.6406" y2="1071.6406"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116" x2="157" y1="1071.6406" y2="1071.6406"/><polygon fill="#A80036" points="126,1067.6406,116,1071.6406,126,1075.6406,122,1071.6406" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1046.2432">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="135" y="1038.5879">Increase NET_DEBIT_CAP with the value of t.amount</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="135" y="1053.8984">TODO:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="181" y="1053.8984">Notify DFSP for NDC change</text><polygon fill="#A80036" points="563,1103.9512,573,1107.9512,563,1111.9512,567,1107.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="569" y1="1107.9512" y2="1107.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="1103.209">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="144" y="1103.209">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f6wzqtfanmqg4)" points="341,1150.9512,819,1150.9512,829,1230.9512,819,1311.9512,341,1311.9512,331,1230.9512,341,1150.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="343" y="1167.5195">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="427" y="1167.5195">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="553" y="1167.5195">(transferId, ilpFulfilment, completedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="371" y="1182.8301">isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="343" y="1198.1406">VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="347" y="1213.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="343" y="1228.7617">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="427" y="1228.7617">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="570" y="1228.7617">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="343" y="1244.0723">VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="347" y="1259.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="343" y="1274.6934">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="427" y="1274.6934">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="371" y="1290.0039">(participantPositionId, transferStateChangeId, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="455" x="343" y="1305.3145">VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})</text><!--
@startuml
title 6.3.2. Settlement Transfer Commit
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Commit
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that has just been SETTLED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve the list of RESERVED, but not COMMITTED
    activate DB
    hnote over DB #lightyellow
        SELECT tp.transferId, tp.participantCurrencyId, tp.amount
        FROM **settlementParticipantCurrency** spc
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RESERVED}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {COMMITTED}
        JOIN **transferParticipant** tp
        ON tp.transferId = spc.settlementTransferId
        AND tp.participantCurrencyId = spc.participantCurrencyId
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Select participantPosition FOR UPDATE
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId, value positionValue, reservedValue
                FROM **participantPosition**
                WHERE participantCurrencyId = t.participantCurrencyId
                FOR UPDATE
            end note
            DB - -> SETTLE_DAO: Return **participantPositionId**, **positionValue** and **reservedValue**
            deactivate DB
            SETTLE_DAO -> DB: Select participant NET_DEBIT_CAP limit
            activate DB
            hnote over DB #lightyellow
                SELECT value AS netDebitCap
                FROM **participantLimit**
                WHERE participantCurrencyId = t.participantCurrencyId
                AND participantLimitTypeId = {NET_DEBIT_CAP}
            end note
            DB - -> SETTLE_DAO: Return **netDebitCap**
            deactivate DB
            note right of SETTLE_DAO #lightgray
                **isLimitExceeded** = netDebitCap - positionValue - reservedValue - t.amount < 0
                **latestPosition** = positionValue + t.amount
            end note
            SETTLE_DAO->DB: Persist latestPosition
            activate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestPosition}
                WHERE participantPositionId = participantPositionId

                SELECT LAST_INSERT_ID() AS participantPositionId
            end note
            DB- ->SETTLE_DAO: Return **participantPositionId**
            deactivate DB
            opt isLimitExceeded == true
                SETTLE_DAO->SETTLE_DAO: Increase NET_DEBIT_CAP with the value of t.amount\n<color #red>TODO:</color> Notify DFSP for NDC change
            end
            deactivate DB
            SETTLE_DAO -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment** (transferId, ilpFulfilment, completedDate, 
                       isValid, settlementWindowId, createdDate)
                VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)

                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')

                INSERT INTO **participantPositionChange**
                       (participantPositionId, transferStateChangeId, value)
                VALUES ({participantPositionId}, {transferStateChangeId}, {latestPosition})
            end note
            activate DB
            deactivate DB
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>